package org.example;

import org.bouncycastle.crypto.generators.OpenBSDBCrypt;
import org.bouncycastle.jce.provider.BouncyCastleProvider;

import java.nio.charset.StandardCharsets;
import java.security.*;
import java.util.*;

class HashPlain{
    String hash;
    char[] plain;
    HashPlain(String _hash, char[] _plain){
        hash = _hash;
        plain = _plain;
    }
}

public class Main {

    public static void main(String[] args) throws NoSuchAlgorithmException {
        var secureRandom = new SecureRandom();
        var random = new Random();

        Boolean[] hit = new Boolean[256];
        Arrays.fill(hit, false);
        for(char c='0';c<='9';++c){
            hit[c] = true;
        }
        hit['.'] = true;
        hit['/'] = true;
        var results = new TreeMap<Double, HashPlain>();

        for(int counter=0;counter<100;counter++) {
            System.out.println(counter);
            int variableCnt = 52;

            byte[] salt = new byte[16];
            secureRandom.nextBytes(salt);
            char[] password = String.valueOf(random.nextInt()).toCharArray();
            var hash = OpenBSDBCrypt.generate("2a", password, salt, 10);

            // ハッシュ値の評価
            Double cnt = 1.0;
            var memo = hit.clone();
            for(int i=0;i<hash.length();++i){
                var c = hash.charAt(i);
                if(memo[c]) {
                    variableCnt++;
                    memo[c] = false;
                }

                if(i >= 7){
                    cnt *= variableCnt;
                }
            }

            Double prob = cnt / Math.pow(64,53);
            results.put(prob, new HashPlain(hash, password));
        }

        // 最後の要素を取り出し
        var target = "";
        char[] targetPlain = "error".toCharArray();
        for(var key: results.keySet()){
            var hashPlain = results.get(key);
            System.out.println("-----");
            System.out.println("prob: " + key.toString());
            System.out.println("hash: " + hashPlain.hash);
            System.out.println("plaintext: " + new String(hashPlain.plain));
            target = hashPlain.hash;
            targetPlain = hashPlain.plain;
        }

        System.out.println("====================");
        System.out.println("targethash: " + target);
        System.out.println("targetPlain: " + new String(targetPlain));

        var cnt = 0;
        var challengeCnt = 1000;
        for(int counter=0;counter<challengeCnt;counter++) {
            System.out.println(counter);
            char[] password = String.valueOf(random.nextInt()).toCharArray();
            var result = OpenBSDBCrypt.checkPassword(target, password);
            System.out.println("challenge: " + new String(password));
            System.out.println("result: " + result);
            if(result) cnt++;
        }
        System.out.println("success: " + cnt);
        System.out.println("challenge: " + challengeCnt);
    }

    
}
